---
title: "Preparación de los datos"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(rio)
library(sf)
library(stars)
library(raster)
library(rasterVis)
library(terra)
library(SDMtune)
library(sdmpredictors)
library(ENMTools)
library(caret)
```


```{r}
sal <- import("01_datos/Conductividad_electrica.csv")
```

```{r}
head(sal)
```
***

### terra (raster)

```{r}
cr_terra <- vect("01_datos/mask/CR_crtm05.gpkg")
```

```{r}
plot(cr_terra)
```

```{r}
cr_terra
```

```{r}
rasters_list <- list.files(path = "01_datos/covs_todas", full.names = TRUE)
```


```{r}
s <- stack(rasters_list)
```

```{r}
s
```

```{r}
newcrs <- "+proj=tmerc +lat_0=0 +lon_0=-84 +k=0.9999 +x_0=500000 +y_0=0 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
```


```{r}
b <- rast(nrow=686, ncol=546, xmin=-87.10198, xmax=-82.55151, ymin=5.49909, ymax=11.21682, crs=newcrs)
```

```{r}
crs(s) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
```

```{r}
s_proy <- project(s, b)
```

```{r}
s_crop <- crop(s, cr_terra)
```

```{r}
s_mask <- mask(s_crop, cr_terra)
```


```{r}
s_mask
```

```{r}
plot(s_mask[[48]])
```


```{r}
raster.cor.matrix(s_mask)
```


***

### stars


```{r}
r1 <- read_stars("01_datos/rasters_cat/C01MCF5.tif")
r2 <- read_stars("01_datos/rasters_cat/C02MCF5.tif")
r3 <- read_stars("01_datos/rasters_cat/C03MCF5.tif")
r4 <- read_stars("01_datos/rasters_cat/C04MCF5.tif")
r5 <- read_stars("01_datos/rasters_cat/C05MCF5.tif")
r6 <- read_stars("01_datos/rasters_cat/C06MCF5.tif")
r7 <- read_stars("01_datos/rasters_cat/C07MCF5.tif")
r8 <- read_stars("01_datos/rasters_cat/C08MCF5.tif")
r9 <- read_stars("01_datos/rasters_cat/C09MCF5.tif")
r10 <- read_stars("01_datos/rasters_cat/C10MCF5.tif")
r11 <- read_stars("01_datos/rasters_cat/C11MCF5.tif")
r12 <- read_stars("01_datos/rasters_cat/C12MCF5.tif")
```


```{r}
r1$cont = 1.0 * as.numeric(r1[[1]])
r2$cont = 1.0 * as.numeric(r2[[1]])
r3$cont = 1.0 * as.numeric(r3[[1]])
r4$cont = 1.0 * as.numeric(r4[[1]])
r5$cont = 1.0 * as.numeric(r5[[1]])
r6$cont = 1.0 * as.numeric(r6[[1]])
r7$cont = 1.0 * as.numeric(r7[[1]])
r8$cont = 1.0 * as.numeric(r8[[1]])
r9$cont = 1.0 * as.numeric(r9[[1]])
r10$cont = 1.0 * as.numeric(r10[[1]])
r11$cont = 1.0 * as.numeric(r11[[1]])
r12$cont = 1.0 * as.numeric(r12[[1]])
```

```{r}
write_stars(r1["cont"], "01_datos/covs_todas/C01MCF5.tif")
write_stars(r2["cont"], "01_datos/covs_todas/C02MCF5.tif")
write_stars(r3["cont"], "01_datos/covs_todas/C03MCF5.tif")
write_stars(r4["cont"], "01_datos/covs_todas/C04MCF5.tif")
write_stars(r5["cont"], "01_datos/covs_todas/C05MCF5.tif")
write_stars(r6["cont"], "01_datos/covs_todas/C06MCF5.tif")
write_stars(r7["cont"], "01_datos/covs_todas/C07MCF5.tif")
write_stars(r8["cont"], "01_datos/covs_todas/C08MCF5.tif")
write_stars(r9["cont"], "01_datos/covs_todas/C09MCF5.tif")
write_stars(r10["cont"], "01_datos/covs_todas/C10MCF5.tif")
write_stars(r11["cont"], "01_datos/covs_todas/C11MCF5.tif")
write_stars(r12["cont"], "01_datos/covs_todas/C12MCF5.tif")
```


```{r}
rasters_list <- list.files(path = "01_datos/covs_todas", full.names = TRUE)
```

```{r}
rasters <- read_stars(rasters_list)
```

```{r}
cr_stars <- st_read("01_datos/mask/CR_cg.gpkg")
```


```{r}
plot(cr_stars)
```


```{r}
rasters_mask <- rasters[cr_stars]
```

```{r}
plot(rasters_mask)
```

```{r}
rasters_p <- st_transform(rasters_mask, crs = 5367)
```

```{r}
st_crs(rasters_p)
```

```{r}
plot(rasters_p, axes = TRUE)
```

```{r}
r001 <- rasters_p[48]
```

```{r}
plot(r001)
```


```{r}
ggplot() + geom_stars(data = r001) +
    coord_equal() +
    theme_void() +
    scale_x_discrete(expand=c(0,0))+
    scale_y_discrete(expand=c(0,0))
```


***

### Extracción de variables

```{r}
cr_crtm05 <- st_read("01_datos/mask/CR_crtm05.gpkg")
```


```{r}
variables <- st_extract(rasters_p, cr_stars)
```



### caret

```{r}
ctrl <- rfeControl(functions = lmFuncs,
                   method = "repeatedcv",
                   repeats = 5,
                   verbose = FALSE)
```


```{r}
lmProfile <- rfe(x, y,
                 sizes = subsets,
                 rfeControl = ctrl)
```




